<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: routes/news.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: routes/news.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file routes/news.js
 * Роуты для CRUD-операций с новостями и real-time уведомлений через Socket.IO.
 */

import express from "express";
import mongoose from "mongoose";
import News from "../models/News.js";
import authMiddleware from "../middleware/auth.js";
import { getIO } from "../services/socket.js";

const router = express.Router();

/**
 * @route POST /api/news
 * @desc Создать новость
 * @access Защищённый
 */
router.post("/", authMiddleware, async (req, res) => {
  const { title, content, publishAt } = req.body;

  try {
    const news = new News({
      author: req.user._id,
      title,
      content,
      publishAt: publishAt ? new Date(publishAt) : null,
      published: false,
    });

    await news.save();

    getIO().emit("news:created", { news });
    res.status(201).json(news);
  } catch (error) {
    res.status(500).json({ message: "Server error" });
  }
});

/**
 * @route PUT /api/news/:id
 * @desc Редактировать новость
 * @access Защищённый
 */
router.put("/:id", authMiddleware, async (req, res) => {
  const { title, content, publishAt, published } = req.body;

  if (!mongoose.Types.ObjectId.isValid(req.params.id)) {
    return res.status(400).json({ message: "Invalid news ID" });
  }

  try {
    const news = await News.findById(req.params.id);

    if (!mongoose.Types.ObjectId.isValid(news)) {
      return res.status(400).json({ message: "Invalid news ID" });
    }

    if (!news.author.equals(req.user._id))
      return res.status(403).json({ message: "Forbidden" });

    if (title) news.title = title;
    if (content) news.content = content;
    if (publishAt !== undefined)
      news.publishAt = publishAt ? new Date(publishAt) : null;
    if (published !== undefined) news.published = published;

    await news.save();

    getIO().emit("news:updated", { news });

    res.json(news);
  } catch (error) {
    res.status(500).json({ message: "Server error" });
  }
});

/**
 * @route DELETE /api/news/:id
 * @desc Удалить новость
 * @access Защищённый
 */
router.delete("/:id", authMiddleware, async (req, res) => {
  try {
    const news = await News.findById(req.params.id);

    if (!news) return res.status(404).json({ message: "News not found" });
    if (!news.author.equals(req.user._id))
      return res.status(403).json({ message: "Forbidden" });

    await news.deleteOne();

    getIO().emit("news:deleted", { newsId: req.params.id });

    res.json({ message: "News deleted" });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "Server error" });
  }
});

/**
 * @route POST /api/news/:id/publish
 * @desc Публикация новости (endpoint для немедленной публикации)
 * @access Защищённый
 */
router.post("/:id/publish", authMiddleware, async (req, res) => {
  try {
    const news = await News.findById(req.params.id);

    if (!news) return res.status(404).json({ message: "News not found" });
    if (!news.author.equals(req.user._id))
      return res.status(403).json({ message: "Forbidden" });

    news.published = true;
    news.publishAt = null; // очищаем отложенную дату, если была
    await news.save();

    res.json({ message: "News published", news });
  } catch (error) {
    res.status(500).json({ message: "Server error" });
  }
});

/**
 * @route GET /api/news
 * @desc Получить все новости пользователя
 * @access Защищённый
 */
router.get("/", authMiddleware, async (req, res) => {
  try {
    const news = await News.find({ author: req.user._id });
    res.json(news);
  } catch (error) {
    res.status(500).json({ message: "Server error" });
  }
});

export default router;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#allowedOrigins">allowedOrigins</a></li><li><a href="global.html#corsOptions">corsOptions</a></li><li><a href="global.html#getIO">getIO</a></li><li><a href="global.html#initSocket">initSocket</a></li><li><a href="global.html#startNewsPublisherJob">startNewsPublisherJob</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Mon Apr 21 2025 20:51:22 GMT+0300 (Москва, стандартное время)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
